@model WeixinTraceMamager.Web.Models.Home_DateLogVD

@{
    ViewBag.Title = "日志 - " + @Model.Date;
    var exceptionCount = Model.WeixinTraceItemList.Count(z => z.IsException);
}

<style>
    .detail_result {
        display: none;
        background: #d8d8d8;
        padding: 8px;
    }

    table td {
        word-break: break-all;
    }

    .exception {
        background: #fcc2c2;
    }

    .not_exception {
    }

    .exceptionCount {
        color: red;
        font-weight: bold;
    }
</style>

@section scripts{
    <script>
        $(function () {
            $('[id^=more_]').click(function () {
                //$(this).hide();
                var curText = $(this).text();
                var numStr = curText.split(' ');
                if (numStr.length > 1) {
                    if (numStr[1] == "点击查看详情") {
                        $('#detail_' + $(this).attr('data-i')).slideDown();
                        $(this).text(numStr[0] + ' 折叠详情');
                    } else {
                        $('#detail_' + $(this).attr('data-i')).hide();
                        $(this).text(numStr[0] + ' 点击查看详情');
                    }
                }




            })

            $('#searchBtn').click(function () {
                showDataAccordingConditions();
            })

            $('.searchAction').bind('change', function () {
                showDataAccordingConditions();
            });

        })

        //展开/折叠带有详情的行
        function showAllDetails() {
            if ($('#showDetailLink').text() == '展开所有详情') {              
                $('#showDetailLink').text("折叠所有详情");
            } else {
                $('#showDetailLink').text("展开所有详情");
            }
            $('#tbList tr:visible').children().find("[id^=detail_]").slideToggle();  // slideUp slideDown

        }


        //根据查询条件，显示隐藏日志列表的行
        function showDataAccordingConditions() {
            var paras = {
                "date": '@Model.Date',
                "ckExcept": $("#ckExcept").prop('checked'),
                "ckDetail": $("#ckDetail").prop('checked'),
                "keyWord": $('#keyWords').val(),
                "title": $('#titleCmb').val() != "不限" ? $("#titleCmb").val():"",
                "type": $('#typeCmd').val() != "不限" ? $("#typeCmd").val() : "",
                "thread": $('#threadCmb').val() != "不限" ? $("#threadCmb").val() : "",
            };
            try {
                $.get('/home/GetDateLog', paras, function (serverData) {  //根据情况修改
                    //if (!isNullOrEmpty(serverData)) {
                    //    $.alert('根据条件获取日志数据失败(' + serverData + ')', "警告！");
                    //    return;
                    //}
                    //if (serverData == "") {
                    //    alert('根据条件获取日志数据失败', "警告！");
                    //    return;
                    //}
                    if (serverData != "" && serverData.indexOf(",") <= 0  && serverData.length>6) {
                        alert('根据条件获取日志数据失败(' + serverData + ')', "警告！");
                        return;
                    }
                    var rows = serverData.split(',');//需要显示的行
                    var allTableData = $('#tbList tr');
                    $('#curConNum').text(rows.length);
                    for (i = allTableData.length - 1; i > 0; i--) {
                        var lineDB = $(allTableData[i]).children().eq(0).html();
                        if (isInArray(rows, lineDB)) {
                            $(allTableData[i]).show();
                            $(allTableData[i]).next().find("[id^=detail_]").parent().parent().show();
                            //var nextRow = $(allTableData[i]).next();
                            //if (nextRow != undefined) {
                            //    var vvvvvv = nextRow.find("[id^=detail_]");
                            //    if (vvvvvv != undefined) {
                            //        vvvvvv.parent().parent().show();
                            //    }
                            //}
                        } else {
                            $(allTableData[i]).hide();
                            $(allTableData[i]).next().find("[id^=detail_]").parent().parent().hide();
                        }

                    }


                });

            } catch (error) {

            }
        }

        function isInArray(arr, value) {
            if (arr == null || arr == undefined || arr.length <= 0) {
                return false;
            }
            for (var i = 0; i < arr.length; i++) {
                if (value === arr[i]) {
                    return true;
                }
            }
            return false;
        }

    </script>
}

<h2>@ViewBag.Title</h2>
<p>
    当前日期的日志共 @Model.WeixinTraceItemList.Count 条记录，涉及 @Model.WeixinTraceItemList.Select(a => a.ThreadId).Distinct().Count() 个线程；
    其中异常记录有 <span class="@(exceptionCount >0 ? "exceptionCount" : "")">@exceptionCount</span> 条，涉及 @Model.WeixinTraceItemList.Where(a => a.IsException).Select(a => a.ThreadId).Distinct().Count() 个线程。
    &nbsp; 当前条件下共有 <span id="curConNum" class="exceptionCount">@Model.WeixinTraceItemList.Count</span> 条记录。
    &nbsp;  &nbsp; &nbsp; &nbsp; @Html.ActionLink(" <<返回日志列表 ", "Index", null, new { @class = "" })
</p>

<form class="form-inline" role="form"style="margin:5px;padding:3px" >
    <div class="checkbox searchAction">
        <label>
            <input id="ckExcept" type="checkbox"> 仅显示异常记录
        </label>
    </div> &nbsp;
    <div class="checkbox searchAction">
        <label>
            <input id="ckDetail" type="checkbox"> 仅显示带有详情的记录
        </label>
    </div> &nbsp;
    关键词:<div class="form-group">
        <label class="sr-only" for="name">关键词</label>
        <input type="text" class="form-control" id="keyWords" placeholder="多个关键词之间用空格分开">
    </div> &nbsp;
    标题:<select id="titleCmb" class="searchAction">
        <option value="不限">不限</option>
        @foreach (var item in Model.WeixinTraceItemList.Select(a => a.Title).Distinct().ToList())
        {
    <option value="@item">@item</option>
        }
    </select> &nbsp;
    类型:<select id="typeCmd" class="searchAction">
        <option value="不限">不限</option>
        @foreach (var item in Model.WeixinTraceItemList.Select(a => a.weixinTraceType.ToString()).Distinct().ToList())
        {
    <option value="@item">@item</option>
        }
    </select> &nbsp;
    线程:<select id="threadCmb" class="searchAction">
        <option value="不限">不限</option>
        @foreach (var item in Model.WeixinTraceItemList.Select(a => a.ThreadId).Distinct().ToList())
        {
    <option value="@item">@item</option>
        }
    </select> &nbsp;
    <button id="searchBtn" type="button" class="btn btn btn-success searchAction">查询</button> &nbsp;&nbsp;
    <a id="showDetailLink" href="javascript:;" style="" onclick="showAllDetails()" class="btn btn-info">展开所有详情</a>
</form>


<table class="table" id="tbList">
    <tr>
        <th style="display:none">行号</th>
        <th width="100px">编号/行号</th>
        <th width="120px">标题</th>
        <th width="120px">时间</th>
        <th width="50px">线程</th>
        <th width="100px">类型</th>
        <th width="80px;">是否异常</th>
        <th>内容</th>
    </tr>
    @{var i = Model.WeixinTraceItemList.Count;}
    @foreach (var item in Model.WeixinTraceItemList)
    {
        var showMessage = false;//是否已输出信息
        <tr class="@(item.IsException?"exception":"not_exception")">
            <td style="display:none">@item.Line</td>
            <td>
                <strong>#@(i)</strong> / @item.Line
            </td>
            <td>@item.Title</td>
            <td>
                @if (item.DateTime != null)
                {
                    @Html.Raw(item.DateTime?.Replace(" ", "<br />"))
                }
            </td>
            <td>@item.ThreadId</td>
            <td>
                @item.weixinTraceType.ToString()
            </td>
            <td>@item.IsException</td>
            <td>
                @if (!string.IsNullOrEmpty(item.Result.Url))
                {
                    <p>
                        <strong>URL：</strong>
                        @item.Result.Url
                    </p>
                }
                @if (!string.IsNullOrEmpty(item.Result.Result))
                {
                    showMessage = true;
                    <p>
                        <strong>返回结果：</strong>
                        @item.Result.Result
                    </p>
                }

                @if (!string.IsNullOrEmpty(item.Result.PostData))
                {
                    showMessage = true;
                    <p>
                        <strong>Post 数据：</strong>
                        @item.Result.PostData
                    </p>
                }

                @if (item.IsException)
                {
                    showMessage = true;
                    <p>
                        <strong>异常信息：</strong>
                        @item.Result.ExceptionMessage
                    </p>
                }
                @if (!showMessage)
                {
                    @Html.Raw(item.Result.ToString())//显示所有结果
                }
            </td>

        </tr>

        if (item.IsShowDetail)
        {
            <tr class="@(item.IsException?"exception":"not_exception")">
                <td colspan="7">
                    <a href="javascript:;" id="more_@i" data-i="@i"><strong>#@i</strong> 点击查看详情</a>
                    <p id="detail_@i" class="detail_result">
                        @Html.Raw(item.Result.ToString())
                    </p>
                </td>
            </tr>
        }

        i--;
    }
</table>
